<?php
// ä¼˜åŒ–äº†version9ï¼šç»™é¢˜ç›®æ·»åŠ äº†ä¸€ä¸ªåˆ é™¤æŒ‰é’®
?>
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¢˜ç›®ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        /* åŸºç¡€æ ·å¼ */
        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        h1,
        h2,
        h3,
        h4 {
            color: #333;
        }

        h1 {
            text-align: center;
        }

        /* è¿‡æ»¤å™¨å’Œè¡¨å•æ ·å¼ */
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        label {
            margin-bottom: 5px;
            font-weight: bold;
        }

        select,
        input,
        button,
        textarea {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        /* æŒ‰é’®æ ·å¼ */
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            align-self: flex-end;
        }

        button:hover {
            background-color: #45a049;
        }

        .btn-secondary {
            background-color: #6c757d;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }
        .delete-btn {
    background-color: #dc3545 !important;
}
 
.delete-btn:hover {
    background-color: #c82333 !important;
}

        /* é¢˜ç›®å¡ç‰‡æ ·å¼ */
        .questions-list {
            margin-top: 20px;
        }

        .question-card {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #fff;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
/* é¢˜ç›®å¡ç‰‡æ ¹æ®éš¾åº¦æ˜¾ç¤ºä¸åŒèƒŒæ™¯è‰² */
.question-card.difficulty-easy  {
    background-color: #e8f5e9; /* æµ…ç»¿è‰² */
    border-left: 4px solid #4CAF50; /* å·¦ä¾§ç»¿è‰²è¾¹æ¡† */
}
 
.question-card.difficulty-medium  {
    background-color: #fff8e1; /* æµ…é»„è‰² */
    border-left: 4px solid #ffc107; /* å·¦ä¾§é»„è‰²è¾¹æ¡† */
}
        .difficulty-easy {
            background-color: #d4edda;
            color: #155724;
        }

        .difficulty-medium {
            background-color: #fff3cd;
            color: #856404;
        }

        .topic {
            font-style: italic;
            color: #6c757d;
        }

        .question-id {
            font-weight: bold;
            color: #333;
            margin-right: 10px;
        }

        /* é¢˜ç›®å†…å®¹åŒºåŸŸ */
        .question-content-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin: 15px 0;
            align-items: flex-start;
        }

        .question-text,
        .original-data-container {
            flex: 1;
            min-width: 300px;
        }

        /* å›¾ç‰‡å®¹å™¨æ ·å¼ï¼ˆæ— è¾¹æ¡†ç‰ˆæœ¬ï¼‰ */
        .question-image-container {
            flex: 1;
            min-width: 200px;
            max-width: 20%;
            text-align: center;
            margin: 10px 0;
        }

        .question-image {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            object-fit: contain;
            background-color: transparent;
        }

        /* ç­”æ¡ˆåŒºåŸŸæ ·å¼ */
        .answer-container {
            margin-top: 15px;
            border: 1px solid #eee;
            border-radius: 4px;
            padding: 10px;
        }

        .answer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 5px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }

        .answer-header h4 {
            margin: 0;
            color: #333;
        }

        .toggle-answer-btn {
            background: none;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
            color: #6c757d;
        }

        .answer-content {
            margin-top: 10px;
            padding: 10px;
            display: none;
        }

        .answer-content.show {
            display: block;
        }

        /* è¡¨æ ¼æ ·å¼ */
        .question-card table {
            border-collapse: collapse;
            width: 100%;
            margin: 10px 0;
        }

        .question-card table,
        .question-card th,
        .question-card td {
            border: 1px solid #ddd;
        }

        .question-card th,
        .question-card td {
            padding: 8px;
            text-align: left;
        }

        /* è¡¨å•æ ·å¼ */
        .add-question-form {
            margin-top: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
        }

        .form-group textarea {
            width: 100%;
            min-height: 100px;
        }

        .form-actions {
            text-align: right;
            margin-top: 15px;
        }

        /* æ‚¬æµ®æŒ‰é’®æ ·å¼ */
        .floating-btn {
            position: fixed;
            bottom: 130px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #4CAF50;
            color: white;
            border: none;
            font-size: 24px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .floating-btn:hover {
            background-color: #45a049;
            transform: scale(1.05);
        }

        .top-floating-btns {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 1000;
        }

        .top-floating-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            background-color: #4285f4;
            color: white;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: all 0.2s;
        }

        .top-floating-btn:hover {
            background-color: #3367d6;
            transform: translateY(-2px);
        }

        .top-floating-btn:nth-child(1) {
            background-color: #4285f4;
        }

        .top-floating-btn:nth-child(2) {
            background-color: #34a853;
        }

        .top-floating-btn:nth-child(3) {
            background-color: #fbbc05;
        }

        .top-floating-btn:nth-child(4) {
            background-color: #ea4335;
        }

        .top-floating-btn:active {
            transform: scale(0.95);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            opacity: 0.9;
        }

        /* å·¥å…·æç¤ºæ ·å¼ */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* ç¼–è¾‘æ¨¡å¼æ ·å¼ */
        .edit-mode {
            border: 2px solid #4CAF50;
            background-color: #f9f9f9;
        }

        .edit-controls {
            display: none;
        }

        .edit-mode .edit-controls {
            display: block;
        }

        .editable-content {
            border: 1px solid #ddd;
            padding: 10px;
            min-height: 100px;
            margin: 10px 0;
            background-color: white;
            outline: none;
        }

        .editable-content:focus {
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }
/* ç¼–è¾‘æŒ‰é’®æ ·å¼ - é»˜è®¤éšè— */
.edit-btn {
    display: none;
    background-color: #6c757d;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 5px 10px;
    cursor: pointer;
    font-size: 0.8em;
    transition: all 0.2s;
}
 
.edit-btn:hover {
    background-color: #5a6268;
}
 
/* é¼ æ ‡æ‚¬åœåœ¨å¡ç‰‡ä¸Šæ—¶æ˜¾ç¤ºç¼–è¾‘æŒ‰é’® */
.question-card:hover .edit-btn {
    display: inline-block;
}
 
/* ç¼–è¾‘æ¨¡å¼ä¸‹å§‹ç»ˆæ˜¾ç¤ºç¼–è¾‘æŒ‰é’® */
.question-card.edit-mode  .edit-btn {
    display: inline-block !important;
}
        .toolbar {
            margin-bottom: 10px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .toolbar button {
            padding: 6px 12px;
            border: 1px solid #555;
            border-radius: 4px;
            cursor: pointer;
            background-color: #555;
            color: white;
            font-weight: bold;
            transition: all 0.2s;
        }

        .toolbar button:hover {
            background-color: #333;
        }

        .toolbar small {
            color: #666;
        }

        .toolbar-separator {
            width: 1px;
            height: 20px;
            background-color: #999;
            margin: 0 5px;
        }

        /* çŠ¶æ€æ ·å¼ */
        .loading {
            text-align: center;
            padding: 20px;
        }

        .error {
            color: #dc3545;
            padding: 10px;
            background-color: #f8d7da;
            border-radius: 4px;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .question-image-container {
                margin: 15px auto;
            }

            .question-content-wrapper {
                flex-direction: column;
            }

            .question-text,
            .original-data-container {
                width: 100%;
                max-width: 100%;
            }
        }
    </style>

</head>

<body>
    <!-- æ–°å¢é¡¶éƒ¨æ‚¬æµ®æŒ‰é’® -->
    <div class="top-floating-btns">
        <button class="top-floating-btn tooltip" id="model-btn">æ¨¡å‹
        </button>
        <button class="top-floating-btn tooltip" id="easy-questions-btn">å‡ºé¢˜
        </button>
        <button class="top-floating-btn tooltip" id="voice-input-btn">å½•é¢˜
        </button>
    </div>

    <div class="container">
        <h1>é¢˜ç›®ç®¡ç†ç³»ç»Ÿ</h1>

        <div class="filters">
            <div class="filter-group">
                <label for="difficulty">éš¾åº¦</label>
                <select id="difficulty">
                    <option value="">å…¨éƒ¨</option>
                    <option value="easy">ç®€å•</option>
                    <option value="medium">ä¸­ç­‰</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="topic">ä¸»é¢˜</label>
                <input type="text" id="topic" placeholder="è¾“å…¥ä¸»é¢˜å…³é”®è¯">
            </div>

            <button id="search-btn">æœç´¢</button>
            <button id="reset-btn">é‡ç½®</button>
        </div>

        <div id="loading" class="loading" style="display: none;">åŠ è½½ä¸­...</div>
        <div id="error" class="error" style="display: none;"></div>

        <div id="questions-list" class="questions-list">
            <!-- é¢˜ç›®å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
        </div>

        <!-- æ–°å¢é¢˜ç›®è¡¨å• (é»˜è®¤éšè—) -->
        <div id="add-question-form" class="add-question-form" style="display: none;">
            <h2>æ–°å¢é¢˜ç›®</h2>
            <div class="form-group">
                <label for="new-difficulty">éš¾åº¦</label>
                <select id="new-difficulty" required>
                    <option value="">è¯·é€‰æ‹©éš¾åº¦</option>
                    <option value="easy">ç®€å•</option>
                    <option value="medium">ä¸­ç­‰</option>
                </select>
            </div>
            <div class="form-group">
                <label for="new-topic">ä¸»é¢˜</label>
                <input type="text" id="new-topic" placeholder="è¾“å…¥ä¸»é¢˜" required>
            </div>
            <div class="form-group">
                <label for="new-question-text">é¢˜ç›®å†…å®¹</label>
                <textarea id="new-question-text" placeholder="è¾“å…¥é¢˜ç›®å†…å®¹" required></textarea>
            </div>
            <div class="form-group">
                <label for="new-question-image">é¢˜ç›®å›¾ç‰‡ (å¯é€‰)</label>
                <div style="display: flex; align-items: center;">
                    <span style="padding: 8px 0; margin-right: 5px;">image/</span>
                    <input type="text" id="new-question-image" placeholder="è¾“å…¥å›¾ç‰‡åç§°å¦‚1.1.1">
                    <span style="padding: 8px 0; margin-left: 5px;">.jpg</span>
                </div>
                <small style="color: #666;">åªéœ€è¾“å…¥ä¸­é—´éƒ¨åˆ†ï¼Œå¦‚1.1.1</small>
            </div>
            <div class="form-group">
                <label for="new-answer-text">ç­”æ¡ˆ</label>
                <textarea id="new-answer-text" placeholder="è¾“å…¥ç­”æ¡ˆ" required></textarea>
            </div>
            <div class="form-actions">
                <button id="cancel-add-btn" class="btn-secondary">å–æ¶ˆ</button>
                <button id="submit-add-btn">æäº¤</button>
            </div>
        </div>
    </div>

    <!-- æ‚¬æµ®çš„æ–°å¢é¢˜ç›®æŒ‰é’® -->
    <button id="add-question-btn" class="floating-btn" title="æ–°å¢é¢˜ç›®">+</button>

<script>
    document.addEventListener('DOMContentLoaded',  function () {
        const difficultySelect = document.getElementById('difficulty'); 
        const topicInput = document.getElementById('topic'); 
        const searchBtn = document.getElementById('search-btn'); 
        const resetBtn = document.getElementById('reset-btn'); 
        const addQuestionBtn = document.getElementById('add-question-btn'); 
        const questionsList = document.getElementById('questions-list'); 
        const loadingElement = document.getElementById('loading'); 
        const errorElement = document.getElementById('error'); 
 
        // æ–°å¢é¢˜ç›®ç›¸å…³å…ƒç´ 
        const addQuestionForm = document.getElementById('add-question-form'); 
        const newDifficulty = document.getElementById('new-difficulty'); 
        const newTopic = document.getElementById('new-topic'); 
        const newQuestionText = document.getElementById('new-question-text'); 
        const newQuestionImage = document.getElementById('new-question-image'); 
        const newAnswerText = document.getElementById('new-answer-text'); 
        const submitAddBtn = document.getElementById('submit-add-btn'); 
        const cancelAddBtn = document.getElementById('cancel-add-btn'); 
 
        // é¡¶éƒ¨æ‚¬æµ®æŒ‰é’®
        const modelBtn = document.getElementById('model-btn'); 
        const easyQuestionsBtn = document.getElementById('easy-questions-btn'); 
        const voiceInputBtn = document.getElementById('voice-input-btn'); 
 
        // åˆå§‹åŠ è½½é¢˜ç›® 
        fetchQuestions();
 


        // é¡¶éƒ¨æ‚¬æµ®æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        modelBtn.addEventListener('click',  function () {
            animateButtonClick(this);
            copyToClipboard("æˆ‘æ˜¯ä¸€ä¸ªåˆä¸­ç‰©ç†è€å¸ˆï¼Œæˆ‘æ­£åœ¨ç»™å­¦ç”Ÿå‡ºé¢˜ï¼Œè¿™é“é¢˜å±äºä»€ä¹ˆç‰©ç†æ¨¡å‹ï¼Ÿç®€è¦å›ç­”ï¼ä¸ç”¨å›ç­”è¿™é“é¢˜ã€‚");
        });
 
        easyQuestionsBtn.addEventListener('click',  function () {
            animateButtonClick(this);
            copyToClipboard("æˆ‘æ˜¯è¯­æ–‡è€å¸ˆï¼Œæ­£åœ¨ç»™å­¦ç”Ÿå‡ºè¯•å·ã€‚æˆ‘æƒ³ä½¿ç”¨åŒä¸€ä¸ªé¢˜å¹²ï¼Œå‡ºä¸ä¸€æ ·éš¾åº¦çš„é¢˜ç›®ç»™å­¦ç”Ÿåˆ†å±‚ç»ƒä¹ ã€‚1ã€è¯†åˆ«å›¾ç‰‡ä¸­çš„é¢˜å¹²ï¼Œä½œä¸ºé¢˜å¹²ä¿¡æ¯ï¼›2ã€è¯·ç»™æˆ‘å‡º3é“éš¾åº¦ä¸åŒçš„å›¾ç‰‡ä¸­çš„é¢˜ç›®ï¼Œæ¯é“é¢˜ä¸‹è®¾é—®3ä¸ªï¼Œå°½é‡ä¿è¯è€ƒå¯Ÿå®ŒçŸ¥è¯†ç‚¹ã€‚");
        });
 
        voiceInputBtn.addEventListener('click',  function () {
            animateButtonClick(this);
            copyToClipboard("æˆ‘ç°åœ¨è¦å½•å…¥è¿™ä¸ªé¢˜çš„ç­”æ¡ˆï¼Œä½†æ˜¯æ‰“å­—å’Œæ’ç‰ˆå¤ªæ…¢äº†ã€‚è¦æ±‚ï¼š1ã€ç»™å‡ºå›¾ç‰‡é¢˜ç›®çš„ç­”æ¡ˆã€‚2ã€å°†ç­”æ¡ˆç”¨htmlæ ¼å¼æ’ç‰ˆï¼Œä»…å†™æ ‡ç­¾ç‰‡æ®µï¼Œä¸å†™å®Œæ•´çš„htmlæ–‡æ¡£ï¼›3ã€å¦‚<p>è¡¨ç¤ºé¢˜å¹²ï¼›ç”¨<ol><li>è¡¨ç¤ºé¢˜å¹²ä¸‹è®¾çš„å°é—®ï¼›ç”¨<sub><sup>ä¸Šä¸‹è§’æ ‡ï¼›ç”¨<table><tr><td>è¡¨ç¤ºé¢˜å¹²ä¸­çš„è¡¨æ ¼ï¼›ç”¨<ol><li>è¡¨ç¤ºç­”æ¡ˆï¼›ä¸éœ€è¦ç»™æ ‡ç­¾æ·»åŠ ä»»ä½•æ ¼å¼ï¼Œä¸èƒ½ä½¿ç”¨å…¶ä»–æ ‡ç­¾ã€‚4ã€å†™æˆä»£ç å½¢å¼ã€‚");
        });
 
        function animateButtonClick(button) {
            button.style.transform  = 'scale(0.95)';
            button.style.boxShadow  = '0 1px 3px rgba(0, 0, 0, 0.2)';
            button.style.opacity  = '0.9';
 
            setTimeout(() => {
                button.style.transform  = '';
                button.style.boxShadow  = '';
                button.style.opacity  = '';
            }, 100);
        }
 
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea'); 
            textarea.value  = text;
            textarea.style.position  = 'fixed';
            textarea.style.opacity  = 0;
            document.body.appendChild(textarea); 
            textarea.select(); 
 
            try {
                const successful = document.execCommand('copy'); 
                if (successful) {
                    showCopyNotification('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                } else {
                    showCopyNotification('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
                }
            } catch (err) {
                console.error(' ä½¿ç”¨execCommandå¤åˆ¶å¤±è´¥:', err);
                if (navigator.clipboard)  {
                    navigator.clipboard.writeText(text).then( 
                        () => showCopyNotification('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'),
                        () => showCopyNotification('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶')
                    );
                } else {
                    showCopyNotification('æµè§ˆå™¨ä¸æ”¯æŒå¤åˆ¶åŠŸèƒ½ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
                }
            }
 
            document.body.removeChild(textarea); 
        }
 
        function showCopyNotification(message) {
            const existingNotification = document.querySelector('.copy-notification'); 
            if (existingNotification) {
                existingNotification.remove(); 
            }
 
            const notification = document.createElement('div'); 
            notification.className  = 'copy-notification';
            notification.textContent  = message;
            document.body.appendChild(notification); 
 
            setTimeout(() => {
                notification.remove(); 
            }, 2000);
        }
 
        // æœç´¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        searchBtn.addEventListener('click',  function () {
            fetchQuestions();
        });
 
        // é‡ç½®æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        resetBtn.addEventListener('click',  function () {
            difficultySelect.value  = '';
            topicInput.value  = '';
            fetchQuestions();
        });
 
        // æ–°å¢é¢˜ç›®æŒ‰é’®ç‚¹å‡»äº‹ä»¶ 
        addQuestionBtn.addEventListener('click',  function () {
            addQuestionForm.style.display  = 'block';
            questionsList.style.display  = 'none';
        });
 
        // å–æ¶ˆæ–°å¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        cancelAddBtn.addEventListener('click',  function () {
            addQuestionForm.style.display  = 'none';
            questionsList.style.display  = 'block';
            resetAddForm();
        });
 
        // æäº¤æ–°å¢é¢˜ç›®æŒ‰é’®ç‚¹å‡»äº‹ä»¶ 
        submitAddBtn.addEventListener('click',  async function () {
            if (!validateAddForm()) {
                return;
            }
 
            try {
                const scrollPosition = window.scrollY; 
                loadingElement.style.display  = 'block';
                errorElement.style.display  = 'none';
 
                const imageName = newQuestionImage.value.trim(); 
                const fullImageUrl = imageName ? `image/${imageName}.jpg` : '';
 
                const response = await fetch('api.php',  {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        action: 'add_question',
                        difficulty: newDifficulty.value, 
                        topic: newTopic.value, 
                        question_text: newQuestionText.value, 
                        question_image: fullImageUrl,
                        answer_text: newAnswerText.value  
                    })
                });
 
                if (!response.ok)  {
                    throw new Error(`æœåŠ¡å™¨è¿”å›é”™è¯¯: ${response.status}`); 
                }
 
                const data = await response.json(); 
 
                if (!data.success)  {
                    throw new Error(data.message  || "æ·»åŠ é¢˜ç›®å¤±è´¥");
                }
 
                addQuestionForm.style.display  = 'none';
                questionsList.style.display  = 'block';
                resetAddForm();
                await fetchQuestions(scrollPosition);
 
            } catch (error) {
                console.error(' æ·»åŠ é¢˜ç›®å¤±è´¥:', error);
                errorElement.innerHTML  = `æ·»åŠ é¢˜ç›®å¤±è´¥: ${error.message}`; 
                errorElement.style.display  = 'block';
            } finally {
                loadingElement.style.display  = 'none';
                if (scrollPosition !== null) {
                    window.scrollTo(0,  scrollPosition);
                }
            }
        });
 
        function validateAddForm() {
            if (!newDifficulty.value)  {
                alert('è¯·é€‰æ‹©éš¾åº¦');
                return false;
            }
            if (!newTopic.value.trim())  {
                alert('è¯·è¾“å…¥ä¸»é¢˜');
                return false;
            }
            if (!newQuestionText.value.trim())  {
                alert('è¯·è¾“å…¥é¢˜ç›®å†…å®¹');
                return false;
            }
            if (!newAnswerText.value.trim())  {
                alert('è¯·è¾“å…¥ç­”æ¡ˆ');
                return false;
            }
            return true;
        }
 
        function resetAddForm() {
            newDifficulty.value  = '';
            newTopic.value  = '';
            newQuestionText.value  = '';
            newQuestionImage.value  = '';
            newAnswerText.value  = '';
        }
 
        async function fetchQuestions(scrollPosition = null) {
            const currentScroll = window.scrollY; 
 
            loadingElement.style.display  = 'block';
            errorElement.style.display  = 'none';
            questionsList.innerHTML  = 'åŠ è½½ä¸­...';
 
            try {
                const difficulty = difficultySelect.value; 
                const topic = topicInput.value.trim(); 
 
                const params = new URLSearchParams();
                params.append('action',  'get_questions');
                if (difficulty) params.append('difficulty',  difficulty);
                if (topic) params.append('topic',  topic);
 
                const response = await fetch(`api.php?${params.toString()}`); 
 
                if (!response.ok)  {
                    throw new Error(`æœåŠ¡å™¨è¿”å›é”™è¯¯: ${response.status}`); 
                }
 
                const data = await response.json(); 
 
                if (!data.success)  {
                    throw new Error(data.message  || "æœåŠ¡å™¨å¤„ç†è¯·æ±‚å¤±è´¥");
                }
 
                if (data.data  && data.data.length  > 0) {
                    const sortedData = data.data.sort((a,  b) => a.question_id  - b.question_id); 
                    displayQuestions(sortedData);
                } else {
                    questionsList.innerHTML  = '<p>æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„é¢˜ç›®</p>';
                }
 
            } catch (error) {
                console.error(' è·å–é¢˜ç›®å¤±è´¥:', error);
                errorElement.innerHTML  = `
                    <p>åŠ è½½é¢˜ç›®å¤±è´¥ï¼Œè¯·è”ç³»ç®¡ç†å‘˜</p>
                    <p><small>é”™è¯¯è¯¦æƒ…: ${error.message}</small></p> 
                `;
                errorElement.style.display  = 'block';
                questionsList.innerHTML  = '<p>æ— æ³•åŠ è½½é¢˜ç›®æ•°æ®</p>';
            } finally {
                loadingElement.style.display  = 'none';
                if (scrollPosition !== null) {
                    window.scrollTo(0,  scrollPosition);
                } else {
                    window.scrollTo(0,  currentScroll);
                }
            }
        }
 
        async function deleteQuestion(questionId, questionCard) {
            try {
                const response = await fetch('api.php',  {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        action: 'delete_question',
                        question_id: questionId 
                    })
                });
    
                if (!response.ok)  {
                    throw new Error(`æœåŠ¡å™¨è¿”å›é”™è¯¯: ${response.status}`); 
                }
    
                const data = await response.json(); 
    
                if (!data.success)  {
                    throw new Error(data.message  || "åˆ é™¤é¢˜ç›®å¤±è´¥");
                }
    
                // ä»DOMä¸­ç§»é™¤é¢˜ç›®å¡ç‰‡ 
                questionCard.remove(); 
                
            } catch (error) {
                console.error(' åˆ é™¤é¢˜ç›®å¤±è´¥:', error);
                errorElement.innerHTML  = `åˆ é™¤é¢˜ç›®å¤±è´¥: ${error.message}`; 
                errorElement.style.display  = 'block';
            }
        }

function displayQuestions(questions) {
    questionsList.innerHTML  = '';
 
    if (questions.length  === 0) {
        questionsList.innerHTML  = '<p style="padding: 20px; text-align: center; color: #666;">æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„é¢˜ç›®</p>';
        return;
    }
 
    questions.forEach(question  => {
        // åˆ›å»ºé¢˜ç›®å¡ç‰‡å®¹å™¨ - æ ¹æ®éš¾åº¦æ·»åŠ å¯¹åº”ç±»å 
        const questionCard = document.createElement('div'); 
        questionCard.className  = `question-card difficulty-${question.difficulty_level}`; 
        questionCard.dataset.questionId  = question.question_id; 
 
        /* ================= é¢˜ç›®å¤´éƒ¨åŒºåŸŸ ================= */
        const questionHeader = document.createElement('div'); 
        questionHeader.className  = 'question-header';
 
        // IDæ˜¾ç¤º 
        const idSpan = document.createElement('span'); 
        idSpan.className  = 'question-id';
        idSpan.textContent  = `ID: ${question.question_id}`; 
 
        // ä¸»é¢˜æ˜¾ç¤º 
        const topicSpan = document.createElement('span'); 
        topicSpan.className  = 'topic';
        topicSpan.textContent  = question.topic  || 'æ— ä¸»é¢˜';
 
        // åˆ é™¤æŒ‰é’®ï¼ˆæ–°å¢ï¼‰
        const deleteBtn = document.createElement('button'); 
        deleteBtn.className  = 'edit-btn delete-btn';
        deleteBtn.textContent  = 'åˆ é™¤';
        deleteBtn.style.cssText  = 'margin-left: 10px; background-color: #dc3545;';
        deleteBtn.addEventListener('click',  (e) => {
            e.stopPropagation(); 
            if (confirm(`ç¡®å®šè¦åˆ é™¤é¢˜ç›®(ID: ${question.question_id}) å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                deleteQuestion(question.question_id,  questionCard);
            }
        });
 
        // ç¼–è¾‘æŒ‰é’® 
        const editBtn = document.createElement('button'); 
        editBtn.className  = 'edit-btn';
        editBtn.textContent  = 'ç¼–è¾‘';
        editBtn.addEventListener('click',  (e) => {
            e.stopPropagation(); 
            const scrollPosition = window.scrollY; 
            enableEditMode(questionCard, question, scrollPosition);
        });
 
        // ç»„è£…å¤´éƒ¨åŒºåŸŸ 
        questionHeader.appendChild(idSpan); 
        questionHeader.appendChild(topicSpan); 
        questionHeader.appendChild(deleteBtn);  // æ–°å¢çš„åˆ é™¤æŒ‰é’® 
        questionHeader.appendChild(editBtn); 
 
        /* ================= é¢˜ç›®å†…å®¹åŒºåŸŸ ================= */
        const contentWrapper = document.createElement('div'); 
        contentWrapper.className  = 'question-content-wrapper';
 
        // é¢˜ç›®æ­£æ–‡éƒ¨åˆ† 
        const questionText = document.createElement('div'); 
        questionText.className  = 'question-text';
        questionText.innerHTML  = question.question_text; 
        questionText.dataset.original  = question.question_text; 
 
        // å›¾ç‰‡å®¹å™¨ 
        let imageContainer = null;
        if (question.question_image)  {
            imageContainer = document.createElement('div'); 
            imageContainer.className  = 'question-image-container';
 
            const img = document.createElement('img'); 
            img.className  = 'question-image';
            img.src  = question.question_image; 
            img.alt  = 'é¢˜ç›®æ’å›¾';
            img.loading  = 'lazy';
            img.style.cssText  = 'display: block; margin: 0 auto;';
 
            imageContainer.appendChild(img); 
        }
 
        // ç»„è£…å†…å®¹åŒºåŸŸ 
        contentWrapper.appendChild(questionText); 
        if (imageContainer) {
            contentWrapper.appendChild(imageContainer); 
        }
 
        /* ================= ç­”æ¡ˆåŒºåŸŸ ================= */
        const answerContainer = document.createElement('div'); 
        answerContainer.className  = 'answer-container';
 
        const answerHeader = document.createElement('div'); 
        answerHeader.className  = 'answer-header';
 
        const answerTitle = document.createElement('h4'); 
        answerTitle.textContent  = 'ğŸ” ç­”æ¡ˆ';
 
        const toggleBtn = document.createElement('button'); 
        toggleBtn.className  = 'toggle-answer-btn';
        toggleBtn.innerHTML  = 'â–¼';
        toggleBtn.title  = 'ç‚¹å‡»å±•å¼€/æ”¶èµ·ç­”æ¡ˆ';
 
        answerHeader.appendChild(answerTitle); 
        answerHeader.appendChild(toggleBtn); 
 
        const answerContent = document.createElement('div'); 
        answerContent.className  = 'answer-content';
        answerContent.innerHTML  = question.answer_text; 
        answerContent.dataset.original  = question.answer_text; 
 
        answerContainer.appendChild(answerHeader); 
        answerContainer.appendChild(answerContent); 
 
        // ç‚¹å‡»åˆ‡æ¢ç­”æ¡ˆæ˜¾ç¤º/éšè— 
        answerHeader.addEventListener('click',  function() {
            answerContent.classList.toggle('show'); 
            toggleBtn.innerHTML  = answerContent.classList.contains('show')  ? 'â–²' : 'â–¼';
        });
 
        /* ================= ç»„è£…å®Œæ•´é¢˜ç›®å¡ç‰‡ ================= */
        questionCard.appendChild(questionHeader); 
        questionCard.appendChild(contentWrapper); 
        questionCard.appendChild(answerContainer); 
 
        // æ·»åŠ åˆ°é¢˜ç›®åˆ—è¡¨ 
        questionsList.appendChild(questionCard); 
    });
}

        function enableEditMode(questionCard, question, scrollPosition) {
            questionCard.classList.add('edit-mode'); 
 
            const originalValues = {
                difficulty: question.difficulty_level, 
                topic: question.topic, 
                question_text: question.question_text, 
                question_image: question.question_image, 
                answer_text: question.answer_text  
            };
 
            const header = questionCard.querySelector('.question-header'); 
            const topicSpan = questionCard.querySelector('.topic'); 
            const questionText = questionCard.querySelector('div:nth-child(2)'); 
            const answerContainer = questionCard.querySelector('.answer-container'); 
            const answerContent = answerContainer.querySelector('.answer-content'); 
 
            // åˆ›å»ºéš¾åº¦é€‰æ‹©ä¸‹æ‹‰æ¡† 
            const difficultySelect = document.createElement('select'); 
            difficultySelect.innerHTML  = `
                <option value="easy" ${question.difficulty_level  === 'easy' ? 'selected' : ''}>ç®€å•</option>
                <option value="medium" ${question.difficulty_level  === 'medium' ? 'selected' : ''}>ä¸­ç­‰</option>
            `;
            difficultySelect.style.cssText  = 'padding: 8px; border-radius: 4px; border: 1px solid #ddd;';
            
            // éš¾åº¦æ”¹å˜æ—¶æ›´æ–°å¡ç‰‡æ ·å¼ 
            difficultySelect.addEventListener('change',  function() {
                questionCard.classList.remove('difficulty-easy',  'difficulty-medium');
                questionCard.classList.add(`difficulty-${this.value}`); 
            });
 
            // åˆ›å»ºä¸»é¢˜è¾“å…¥æ¡†
            const topicInput = document.createElement('input'); 
            topicInput.type  = 'text';
            topicInput.value  = question.topic  || '';
            topicInput.style.cssText  = 'padding: 8px; width: 200px; border-radius: 4px; border: 1px solid #ddd;';
 
            // åˆ›å»ºå¯ç¼–è¾‘çš„é¢˜ç›®å†…å®¹åŒºåŸŸ
            const editableQuestion = document.createElement('div'); 
            editableQuestion.className  = 'editable-content';
            editableQuestion.contentEditable  = true;
            editableQuestion.innerHTML  = question.question_text; 
 
            // åˆ›å»ºé¢˜ç›®å†…å®¹å·¥å…·æ 
            const questionToolbar = createToolbar(editableQuestion, 'question');
 
            // åˆ›å»ºå¯ç¼–è¾‘çš„ç­”æ¡ˆå†…å®¹åŒºåŸŸ
            const editableAnswer = document.createElement('div'); 
            editableAnswer.className  = 'answer-content editable-content';
            editableAnswer.contentEditable  = true;
            editableAnswer.innerHTML  = question.answer_text; 
 
            // åˆ›å»ºç­”æ¡ˆå†…å®¹å·¥å…·æ 
            const answerToolbar = createToolbar(editableAnswer, 'answer');
 
            // æ›¿æ¢åŸæœ‰å…ƒç´ ä¸ºå¯ç¼–è¾‘ç‰ˆæœ¬
            topicSpan.replaceWith(topicInput); 
 
            // æ’å…¥é¢˜ç›®å·¥å…·æ å’Œå¯ç¼–è¾‘åŒºåŸŸ 
            questionText.parentNode.insertBefore(questionToolbar,  questionText);
            questionText.replaceWith(editableQuestion); 
 
            // ä¿®æ”¹ç­”æ¡ˆéƒ¨åˆ†ç»“æ„
            const answerHeader = answerContainer.querySelector('.answer-header'); 
            answerHeader.querySelector('h4').textContent  = 'ç­”æ¡ˆï¼ˆç¼–è¾‘æ¨¡å¼ï¼‰';
            const toggleBtn = answerHeader.querySelector('.toggle-answer-btn'); 
            if (toggleBtn) toggleBtn.remove(); 
 
            // æ›¿æ¢ç­”æ¡ˆå†…å®¹å¹¶æ’å…¥å·¥å…·æ 
            answerContent.replaceWith(editableAnswer); 
            answerHeader.parentNode.insertBefore(answerToolbar,  answerHeader.nextSibling); 
            editableAnswer.classList.add('show'); 
 
            // åˆ›å»ºä¿å­˜æŒ‰é’®
            const saveBtn = document.createElement('button'); 
            saveBtn.className  = 'edit-btn save-btn';
            saveBtn.textContent  = 'ä¿å­˜';
            saveBtn.style.cssText  = 'margin-left: 10px; padding: 8px 16px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;';
            saveBtn.addEventListener('click',  async () => {
                const success = await saveChanges(questionCard, {
                    difficulty: difficultySelect.value, 
                    topic: topicInput.value, 
                    question_text: editableQuestion.innerHTML, 
                    answer_text: editableAnswer.innerHTML  
                });
                if (success) {
                    questionCard.classList.remove('edit-mode'); 
                    fetchQuestions().then(() => {
                        window.scrollTo(0,  scrollPosition);
                    });
                }
            });
 
            // åˆ›å»ºå–æ¶ˆæŒ‰é’®
            const cancelBtn = document.createElement('button'); 
            cancelBtn.className  = 'edit-btn cancel-btn';
            cancelBtn.textContent  = 'å–æ¶ˆ';
            cancelBtn.style.cssText  = 'margin-left: 10px; padding: 8px 16px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;';
            cancelBtn.addEventListener('click',  () => {
                difficultySelect.value  = originalValues.difficulty; 
                topicInput.value  = originalValues.topic; 
                editableQuestion.innerHTML  = originalValues.question_text; 
                editableAnswer.innerHTML  = originalValues.answer_text; 
 
                questionCard.classList.remove('edit-mode'); 
                fetchQuestions().then(() => {
                    window.scrollTo(0,  scrollPosition);
                });
            });
 
            // ç§»é™¤åŸæœ‰çš„ç¼–è¾‘æŒ‰é’®
            const editBtn = questionCard.querySelector('.edit-btn'); 
            if (editBtn) editBtn.remove(); 
 
            // æ·»åŠ æ“ä½œæŒ‰é’® 
            header.appendChild(saveBtn); 
            header.appendChild(cancelBtn); 
        }
 
        function createToolbar(editableElement, type) {
            const toolbar = document.createElement('div'); 
            toolbar.className  = 'toolbar';
 
            const toggleHtmlBtn = document.createElement('button'); 
            toggleHtmlBtn.textContent  = 'æŸ¥çœ‹HTML';
            toggleHtmlBtn.title  = 'åˆ‡æ¢æŸ¥çœ‹HTMLæºä»£ç ';
 
            const handleFormatButtonClick = (tag) => {
                const isHtmlMode = editableElement.getAttribute('data-html-mode')  === 'true';
 
                if (isHtmlMode) {
                    const textarea = editableElement.querySelector('textarea'); 
                    const startPos = textarea.selectionStart; 
                    const endPos = textarea.selectionEnd; 
 
                    let insertContent = '';
                    if (tag === 'table') {
                        insertContent =
                            '<table>\n' +
                            '  <tr>\n' +
                            '    <td>ç¬¬1è¡Œç¬¬1åˆ—</td>\n' +
                            '    <td>ç¬¬1è¡Œç¬¬2åˆ—</td>\n' +
                            '  </tr>\n' +
                            '  <tr>\n' +
                            '    <td>ç¬¬2è¡Œç¬¬1åˆ—</td>\n' +
                            '    <td>ç¬¬2è¡Œç¬¬1åˆ—</td>\n' +
                            '  </tr>\n' +
                            '</table>';
                    } else if (tag === 'ul') {
                        insertContent = '<ul>\n  <li>åˆ—è¡¨é¡¹1</li>\n  <li>åˆ—è¡¨é¡¹2</li>\n</ul>';
                    } else if (tag === 'br') {
                        insertContent = '<br>';
                    } else {
                        const selectedText = textarea.value.substring(startPos,  endPos);
                        insertContent = `<${tag}>${selectedText || ''}</${tag}>`;
                    }
 
                    const beforeText = textarea.value.substring(0,  startPos);
                    const afterText = textarea.value.substring(endPos); 
                    textarea.value  = beforeText + insertContent + afterText;
 
                    setTimeout(() => {
                        if (tag === 'table' || tag === 'ul') {
                            const contentPos = beforeText.length  + insertContent.indexOf(' å†…å®¹');
                            textarea.selectionStart  = contentPos;
                            textarea.selectionEnd  = contentPos + 2;
                        } else {
                            const cursorPos = beforeText.length  + insertContent.length; 
                            if (insertContent.endsWith(`</${tag}>`))  {
                                textarea.selectionStart  = beforeText.length  + `<${tag}>`.length;
                                textarea.selectionEnd  = textarea.selectionStart; 
                            } else {
                                textarea.selectionStart  = cursorPos;
                                textarea.selectionEnd  = cursorPos;
                            }
                        }
                        textarea.focus(); 
                    }, 0);
                } else {
                    const selection = window.getSelection(); 
                    if (!selection.rangeCount)  return;
 
                    const range = selection.getRangeAt(0); 
                    const selectedText = range.toString(); 
 
                    let parent = range.commonAncestorContainer; 
                    while (parent && parent !== editableElement) {
                        if (parent.nodeName  === tag.toUpperCase())  {
                            const textNode = document.createTextNode(parent.textContent); 
                            parent.parentNode.replaceChild(textNode,  parent);
                            return;
                        }
                        parent = parent.parentNode; 
                    }
 
                    let newContent = '';
                    switch (tag) {
                        case 'table':
                            newContent = `<table><tr><td>å†…å®¹</td><td>å†…å®¹</td></tr><tr><td>å†…å®¹</td><td>å†…å®¹</td></tr></table>`;
                            break;
                        case 'ul':
                            newContent = `<ul><li>åˆ—è¡¨é¡¹</li><li>åˆ—è¡¨é¡¹</li></ul>`;
                            break;
                        case 'br':
                            newContent = `<br>`;
                            break;
                        default:
                            newContent = `<${tag}>${selectedText}</${tag}>`;
                    }
 
                    if (selectedText) {
                        range.deleteContents(); 
                        range.insertNode(document.createRange().createContextualFragment(newContent)); 
                    } else {
                        range.insertNode(document.createRange().createContextualFragment(newContent)); 
                    }
 
                    editableElement.focus(); 
                }
            };
 
            toggleHtmlBtn.addEventListener('click',  function () {
                const isHtmlMode = editableElement.getAttribute('data-html-mode')  === 'true';
 
                if (isHtmlMode) {
                    const textarea = editableElement.querySelector('textarea'); 
                    const htmlContent = textarea.value; 
 
                    editableElement.innerHTML  = htmlContent;
                    editableElement.contentEditable  = true;
                    editableElement.removeAttribute('data-html-mode'); 
                    toggleHtmlBtn.textContent  = 'æŸ¥çœ‹HTML';
                } else {
                    const htmlContent = editableElement.innerHTML; 
                    editableElement.setAttribute('data-original-html',  htmlContent);
 
                    const textarea = document.createElement('textarea'); 
                    textarea.value  = htmlContent;
                    textarea.style.width  = '100%';
                    textarea.style.minHeight  = '150px';
                    textarea.style.padding  = '10px';
                    textarea.style.fontFamily  = 'monospace';
                    textarea.style.whiteSpace  = 'pre';
 
                    editableElement.innerHTML  = '';
                    editableElement.appendChild(textarea); 
                    editableElement.contentEditable  = false;
                    editableElement.setAttribute('data-html-mode',  'true');
                    toggleHtmlBtn.textContent  = 'è¿”å›ç¼–è¾‘';
                }
            });
 
            toolbar.appendChild(toggleHtmlBtn); 
 
            const addButton = (text, tag, icon = null) => {
                const btn = document.createElement('button'); 
                btn.title  = text;
 
                if (icon) {
                    btn.innerHTML  = icon;
                } else {
                    btn.textContent  = text;
                }
 
                btn.addEventListener('click',  (e) => {
                    e.preventDefault(); 
                    handleFormatButtonClick(tag);
                });
 
                toolbar.insertBefore(btn,  toggleHtmlBtn);
                return btn;
            };
 
            addButton('B', 'b');
            addButton('ä¸Šæ ‡', 'sup');
            addButton('ä¸‹æ ‡', 'sub');
            addButton('åˆ—è¡¨', 'ul');
            addButton('è¡¨æ ¼', 'table');
            addButton('æ¢è¡Œ', 'br', 'â†µ');
 
            const separator = document.createElement('div'); 
            separator.className  = 'toolbar-separator';
            toolbar.insertBefore(separator,  toggleHtmlBtn);
 
            const tip = document.createElement('small'); 
            tip.textContent  = 'é€‰ä¸­æ–‡å­—åç‚¹å‡»æŒ‰é’®æ·»åŠ æ ¼å¼';
            toolbar.insertBefore(tip,  toggleHtmlBtn);
 
            return toolbar;
        }
 
        async function saveChanges(questionCard, updatedData) {
            const questionId = questionCard.dataset.questionId; 
 
            try {
                loadingElement.style.display  = 'block';
                errorElement.style.display  = 'none';
 
                const response = await fetch('api.php',  {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        action: 'update_question',
                        question_id: questionId,
                        difficulty: updatedData.difficulty, 
                        topic: updatedData.topic, 
                        question_text: updatedData.question_text, 
                        answer_text: updatedData.answer_text 
                    })
                });
 
                if (!response.ok)  {
                    throw new Error(`æœåŠ¡å™¨è¿”å›é”™è¯¯: ${response.status}`); 
                }
 
                const data = await response.json(); 
 
                if (!data.success)  {
                    throw new Error(data.message  || "æ›´æ–°é¢˜ç›®å¤±è´¥");
                }
 
                return true;
 
            } catch (error) {
                console.error(' æ›´æ–°é¢˜ç›®å¤±è´¥:', error);
                errorElement.innerHTML  = `æ›´æ–°é¢˜ç›®å¤±è´¥: ${error.message}`; 
                errorElement.style.display  = 'block';
                return false;
            } finally {
                loadingElement.style.display  = 'none';
            }
        }
    });
</script>

</body>

</html>